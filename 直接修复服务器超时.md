# 直接修复服务器超时问题

## 问题分析

根据错误信息和测试结果：
1. **前端超时设置太短**: axios timeout 设置为 10000ms (10秒)
2. **后端查询正常**: 实际测试显示API响应时间约1.8秒，完全正常
3. **缓存逻辑bug**: 后端缓存代码在return之后，永远不会执行

## 解决方案

### 方案1: 通过SSH直接修改（推荐）

```bash
# 连接到服务器
ssh root@47.108.152.16

# 进入项目目录
cd /opt/kg

# 1. 修改前端超时配置
# 备份原文件
cp apps/web/src/api/index.js apps/web/src/api/index.js.backup

# 修改超时时间
sed -i 's/timeout: 10000/timeout: 60000/g' apps/web/src/api/index.js

# 验证修改
grep "timeout:" apps/web/src/api/index.js

# 2. 修改后端缓存逻辑
# 备份原文件
cp api/main.py api/main.py.backup

# 手动编辑文件（在第721行附近）
# 将:
#   return {
#       "ok": True,
#       ...
#   }
# 改为:
#   result = {
#       "ok": True,
#       ...
#   }
#   await QueryCache.set_graph_data(cache_key, result, depth=1, ttl=600)
#   return result

vi api/main.py
# 或使用 nano api/main.py

# 3. 重启服务
docker-compose -f docker-compose.prod.yml restart web
docker-compose -f docker-compose.prod.yml restart api

# 4. 检查服务状态
docker-compose -f docker-compose.prod.yml ps

# 5. 查看日志
docker-compose -f docker-compose.prod.yml logs api --tail=50
docker-compose -f docker-compose.prod.yml logs web --tail=50
```

### 方案2: 临时增加Nginx超时（快速修复）

如果不想修改代码，可以临时增加Nginx的超时设置：

```bash
ssh root@47.108.152.16

cd /opt/kg

# 编辑Nginx配置
vi nginx/nginx.conf

# 在 location /api/ 块中添加:
# proxy_read_timeout 60s;
# proxy_connect_timeout 60s;
# proxy_send_timeout 60s;

# 重启Nginx
docker-compose -f docker-compose.prod.yml restart nginx

# 检查状态
docker-compose -f docker-compose.prod.yml ps
```

### 方案3: 优化后端查询性能

如果查询确实很慢，可以优化Neo4j查询：

```bash
ssh root@47.108.152.16

# 进入Neo4j容器
docker exec -it kg-neo4j-1 cypher-shell -u neo4j -p your_password

# 创建索引以加速查询
CREATE INDEX IF NOT EXISTS FOR (n:Term) ON (n.name);
CREATE INDEX IF NOT EXISTS FOR (n:Category) ON (n.name);
CREATE INDEX IF NOT EXISTS FOR (n:Tag) ON (n.name);
CREATE INDEX IF NOT EXISTS FOR (n:Component) ON (n.name);
CREATE INDEX IF NOT EXISTS FOR (n:Symptom) ON (n.name);

# 查看现有索引
SHOW INDEXES;

# 退出
:exit
```

## 修改后的代码片段

### 前端 (apps/web/src/api/index.js)

```javascript
// 修改前
const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL || 'http://localhost:8000',
  timeout: 10000,  // ← 改这里
  headers: {
    'Content-Type': 'application/json'
  }
})

// 修改后
const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL || 'http://localhost:8000',
  timeout: 60000,  // ← 改为60秒
  headers: {
    'Content-Type': 'application/json'
  }
})
```

### 后端 (api/main.py, 第713-739行)

```python
# 修改前
stats = {
    "totalNodes": total_nodes,
    "totalRelations": total_relations,
    "totalTerms": total_terms,
    "totalCategories": total_categories,
    "totalTags": total_tags
}

return {  # ← 这里直接return了
    "ok": True,
    "success": True,
    "data": {
        "stats": stats,
        "categories": categories,
        "tags": [],
        "nodes": nodes,
        "links": relations,
        "relations": relations,
        "sampleNodes": nodes,
        "sampleRelations": relations
    },
    "message": "获取实时图谱数据成功"
}

# 缓存结果 ← 这段代码永远不会执行
await QueryCache.set_graph_data(cache_key, result, depth=1, ttl=600)
return result

# 修改后
stats = {
    "totalNodes": total_nodes,
    "totalRelations": total_relations,
    "totalTerms": total_terms,
    "totalCategories": total_categories,
    "totalTags": total_tags
}

result = {  # ← 先赋值给变量
    "ok": True,
    "success": True,
    "data": {
        "stats": stats,
        "categories": categories,
        "tags": [],
        "nodes": nodes,
        "links": relations,
        "relations": relations,
        "sampleNodes": nodes,
        "sampleRelations": relations
    },
    "message": "获取实时图谱数据成功"
}

# 缓存结果 ← 现在会执行
await QueryCache.set_graph_data(cache_key, result, depth=1, ttl=600)
return result
```

## 验证修复

修复后，在浏览器中访问：
- http://47.108.152.16/
- 点击"图谱可视化"菜单
- 应该能正常加载图谱数据，不再出现超时错误

## 如果仍有问题

1. 查看浏览器控制台错误
2. 查看API日志: `docker-compose -f docker-compose.prod.yml logs api -f`
3. 查看Nginx日志: `docker-compose -f docker-compose.prod.yml logs nginx -f`
4. 测试API直接访问: `curl http://47.108.152.16/api/kg/graph?limit=100`


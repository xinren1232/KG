# 阿里云服务器部署现状分析

**服务器IP**: 47.108.152.16  
**检查时间**: 2025-10-04 01:20  
**项目路径**: `/opt/knowledge-graph/`

---

## 📊 部署现状总结

### ✅ 已部署的服务

| 服务 | 状态 | 端口 | 说明 |
|------|------|------|------|
| **Nginx** | ✅ 运行中 | 80 | 系统级服务，反向代理 |
| **前端Vite** | ✅ 运行中 | 5173 | Vue.js开发服务器 |
| **项目文件** | ✅ 已上传 | - | 完整项目结构 |

### ❌ 未部署的服务

| 服务 | 状态 | 端口 | 影响 |
|------|------|------|------|
| **API服务** | ❌ 未运行 | 8000 | 所有API调用返回502 |
| **Neo4j** | ❌ 未安装 | 7474, 7687 | 无法查询图谱数据 |
| **Redis** | ❌ 未运行 | 6379 | 无缓存功能 |

---

## 🔍 详细分析

### 1. 项目文件结构 ✅

项目已完整上传到 `/opt/knowledge-graph/`，包含：

```
/opt/knowledge-graph/
├── api/                    # ✅ API服务代码
│   ├── main.py            # FastAPI主文件
│   ├── requirements.txt   # Python依赖
│   ├── api/               # API模块
│   ├── schemas/           # 数据模型
│   ├── middleware/        # 中间件
│   └── ...
├── apps/
│   └── web/               # ✅ 前端代码
│       ├── src/           # Vue源码
│       ├── package.json   # Node依赖
│       └── node_modules/  # 已安装依赖
├── config/                # ✅ 配置文件
├── data/                  # ✅ 数据文件
├── nginx/                 # ✅ Nginx配置
├── .env                   # ✅ 环境变量
├── docker-compose.yml     # Docker配置（未使用）
└── README.md
```

### 2. 前端服务 ✅

**状态**: 正常运行

```bash
# 运行进程
root  36579  node /opt/knowledge-graph/apps/web/node_modules/.bin/vite.js --host 0.0.0.0 --port 5173

# 端口监听
tcp  0.0.0.0:5173  LISTEN  36579/node

# HTTP测试
curl http://localhost:5173/  # 返回 200 ✅
```

**访问方式**:
- 内部: http://localhost:5173/
- 外部: http://47.108.152.16/ (通过Nginx代理)

### 3. Nginx配置 ✅

**配置文件**: `/etc/nginx/sites-available/knowledge-graph`

```nginx
server {
    listen 80;
    server_name 47.108.152.16;

    # 前端 - 代理到5173端口 ✅
    location / {
        proxy_pass http://localhost:5173;
        ...
    }

    # API - 代理到8000端口 ❌ 服务未运行
    location /api/ {
        proxy_pass http://localhost:8000/;
        ...
    }

    # Neo4j - 代理到7474端口 ❌ 服务未运行
    location /neo4j/ {
        proxy_pass http://localhost:7474/;
        ...
    }
}
```

**问题**: Nginx配置正确，但后端服务未启动。

### 4. API服务 ❌

**状态**: 未运行

```bash
# 检查进程
ps aux | grep python.*main.py  # 无结果

# 检查端口
netstat -tlnp | grep 8000  # 无监听

# HTTP测试
curl http://localhost:8000/health  # 连接失败
```

**原因**: API服务从未启动。

**需要执行**:
```bash
cd /opt/knowledge-graph/api
pip3 install -r requirements.txt
python3 main.py
# 或
uvicorn main:app --host 0.0.0.0 --port 8000
```

### 5. Neo4j数据库 ❌

**状态**: 未安装

```bash
systemctl status neo4j  # Unit neo4j.service could not be found
```

**需要执行**:
1. 安装Neo4j
2. 配置认证 (neo4j/password123)
3. 启动服务

### 6. Redis缓存 ❌

**状态**: 未运行

```bash
ps aux | grep redis  # 无结果
netstat -tlnp | grep 6379  # 无监听
```

**需要执行**:
1. 安装Redis
2. 启动服务

### 7. 环境变量 ✅

**文件**: `/opt/knowledge-graph/.env`

```env
# Neo4j配置
NEO4J_URI=bolt://neo4j:7687  # ⚠️ 指向Docker容器，需要改为localhost
NEO4J_USER=neo4j
NEO4J_PASSWORD=password123

# Redis配置
REDIS_HOST=redis  # ⚠️ 指向Docker容器，需要改为localhost
REDIS_PORT=6379

# API配置
API_HOST=0.0.0.0
API_PORT=8000
```

**问题**: 配置指向Docker容器名，但实际未使用Docker。

---

## 🎯 问题根本原因

你之前的部署：
1. ✅ 上传了完整的项目文件
2. ✅ 启动了前端Vite开发服务器
3. ✅ 配置了Nginx反向代理
4. ❌ **但没有启动后端服务**（API、Neo4j、Redis）

这就是为什么：
- 前端页面可以访问（Vite在运行）
- API调用返回502错误（API服务未运行）
- 无法查询图谱数据（Neo4j未安装）

---

## 💡 解决方案

### 方案A: 非Docker部署（推荐，符合你的本地环境）

按照本地开发环境的方式部署，不使用Docker：

#### 步骤1: 安装Neo4j

```bash
# 添加Neo4j仓库
wget -O - https://debian.neo4j.com/neotechnology.gpg.key | sudo apt-key add -
echo 'deb https://debian.neo4j.com stable latest' | sudo tee /etc/apt/sources.list.d/neo4j.list

# 安装Neo4j
sudo apt update
sudo apt install neo4j

# 配置Neo4j
sudo neo4j-admin set-initial-password password123

# 启动Neo4j
sudo systemctl enable neo4j
sudo systemctl start neo4j

# 验证
curl http://localhost:7474/
```

#### 步骤2: 安装Redis

```bash
# 安装Redis
sudo apt install redis-server

# 启动Redis
sudo systemctl enable redis-server
sudo systemctl start redis-server

# 验证
redis-cli ping  # 应返回 PONG
```

#### 步骤3: 修改环境变量

```bash
cd /opt/knowledge-graph

# 修改.env文件
nano .env

# 修改以下内容:
NEO4J_URI=bolt://localhost:7687  # 改为localhost
REDIS_HOST=localhost              # 改为localhost
```

#### 步骤4: 启动API服务

```bash
cd /opt/knowledge-graph/api

# 安装Python依赖
pip3 install -r requirements.txt

# 启动API服务（后台运行）
nohup python3 main.py > /var/log/kg-api.log 2>&1 &

# 或使用uvicorn
nohup uvicorn main:app --host 0.0.0.0 --port 8000 > /var/log/kg-api.log 2>&1 &

# 验证
curl http://localhost:8000/health
```

#### 步骤5: 创建systemd服务（推荐）

让API服务开机自启：

```bash
# 创建服务文件
sudo nano /etc/systemd/system/kg-api.service
```

内容：
```ini
[Unit]
Description=Knowledge Graph API Service
After=network.target neo4j.service redis.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/knowledge-graph/api
Environment="PATH=/usr/local/bin:/usr/bin:/bin"
ExecStart=/usr/bin/python3 main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable kg-api
sudo systemctl start kg-api
sudo systemctl status kg-api
```

### 方案B: Docker部署（需要修改配置）

如果想使用Docker，需要：
1. 确保Docker和Docker Compose已安装
2. 修改docker-compose.yml
3. 停止当前的Vite进程
4. 使用docker-compose启动所有服务

---

## 📋 立即执行的修复步骤

### 快速修复（最小化改动）

```bash
# 1. 安装Neo4j
wget -O - https://debian.neo4j.com/neotechnology.gpg.key | sudo apt-key add -
echo 'deb https://debian.neo4j.com stable latest' | sudo tee /etc/apt/sources.list.d/neo4j.list
sudo apt update
sudo apt install neo4j -y
sudo neo4j-admin set-initial-password password123
sudo systemctl start neo4j

# 2. 安装Redis
sudo apt install redis-server -y
sudo systemctl start redis-server

# 3. 修改环境变量
cd /opt/knowledge-graph
sed -i 's/bolt:\/\/neo4j:7687/bolt:\/\/localhost:7687/g' .env
sed -i 's/REDIS_HOST=redis/REDIS_HOST=localhost/g' .env

# 4. 安装API依赖并启动
cd /opt/knowledge-graph/api
pip3 install -r requirements.txt
nohup python3 main.py > /var/log/kg-api.log 2>&1 &

# 5. 验证
sleep 5
curl http://localhost:8000/health
curl http://localhost:7474/
```

---

## 🚀 我可以帮你执行

我可以通过SSH帮你：

1. **安装Neo4j和Redis**
2. **修改环境变量**
3. **启动API服务**
4. **创建systemd服务**（让服务开机自启）
5. **验证所有服务**

请确认是否让我执行？

---

## 📊 预期结果

完成后，服务器将运行：

| 服务 | 端口 | 状态 | 访问方式 |
|------|------|------|----------|
| Nginx | 80 | ✅ | http://47.108.152.16/ |
| 前端Vite | 5173 | ✅ | 内部访问 |
| API服务 | 8000 | ✅ | http://47.108.152.16/api/ |
| Neo4j | 7474, 7687 | ✅ | http://47.108.152.16/neo4j/ |
| Redis | 6379 | ✅ | 内部访问 |

所有功能将完全可用，与本地开发环境一致！


# 阿里云服务器部署修复指南

## 问题诊断

访问 http://47.108.152.16/ 时页面显示空白，主要原因：

1. **前端未构建**: Vue应用需要构建成静态文件（dist目录）
2. **Nginx配置问题**: 原配置强制HTTPS重定向，但服务器没有SSL证书
3. **静态文件缺失**: nginx配置指向的 `/usr/share/nginx/html` 目录为空

## 解决方案

### 方案A: 在本地构建后上传（推荐）

适用于本地有Node.js环境的情况。

#### 1. 在本地Windows机器上构建

```bash
# 运行构建脚本
build_and_deploy.bat
```

或手动执行：

```bash
# 进入前端目录
cd apps\web

# 安装依赖（如果还没安装）
npm install

# 构建前端
npm run build

# 返回项目根目录
cd ..\..

# 复制构建文件
xcopy /E /I /Y apps\web\dist dist

# 更新nginx配置
copy /Y nginx\nginx.http.conf nginx\nginx.conf
```

#### 2. 上传文件到服务器

使用SCP或FTP工具上传以下文件到服务器：

```bash
# 上传dist目录
scp -r dist/ root@47.108.152.16:/opt/kg/

# 上传nginx配置
scp nginx/nginx.conf root@47.108.152.16:/opt/kg/nginx/

# 上传docker-compose配置
scp docker-compose.prod.yml root@47.108.152.16:/opt/kg/
```

#### 3. 在服务器上重启服务

SSH登录到服务器：

```bash
ssh root@47.108.152.16
cd /opt/kg

# 停止现有容器
docker-compose -f docker-compose.prod.yml down

# 重新启动（使用新配置）
docker-compose -f docker-compose.prod.yml up -d --build

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看nginx日志
docker-compose -f docker-compose.prod.yml logs nginx
```

### 方案B: 在服务器上直接构建

适用于服务器上有Node.js环境的情况。

#### 1. SSH登录到服务器

```bash
ssh root@47.108.152.16
cd /opt/kg
```

#### 2. 安装Node.js（如果未安装）

```bash
# 安装Node.js 18.x
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs

# 验证安装
node --version
npm --version
```

#### 3. 构建前端

```bash
# 进入前端目录
cd apps/web

# 安装依赖
npm install

# 构建
npm run build

# 返回项目根目录
cd ../..

# 复制构建文件
cp -r apps/web/dist ./dist

# 更新nginx配置
cp nginx/nginx.http.conf nginx/nginx.conf
```

#### 4. 重启服务

```bash
# 停止现有容器
docker-compose -f docker-compose.prod.yml down

# 重新启动
docker-compose -f docker-compose.prod.yml up -d --build

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps
```

### 方案C: 快速修复（临时方案）

如果只是想快速看到效果，可以创建一个简单的测试页面：

#### 1. SSH登录到服务器

```bash
ssh root@47.108.152.16
cd /opt/kg
```

#### 2. 创建临时测试页面

```bash
# 创建dist目录
mkdir -p dist

# 创建简单的index.html
cat > dist/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>质量知识图谱助手</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        h1 { color: #409EFF; }
        .status { 
            padding: 10px; 
            background: #f0f9ff; 
            border-left: 4px solid #409EFF;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>质量知识图谱助手</h1>
    <div class="status">
        <p>✓ 系统正在运行</p>
        <p>前端应用正在构建中...</p>
    </div>
    <h2>系统信息</h2>
    <ul>
        <li>服务器: 阿里云</li>
        <li>访问地址: http://47.108.152.16/</li>
        <li>API地址: <a href="/api/health">/api/health</a></li>
    </ul>
</body>
</html>
EOF

# 更新nginx配置
cp nginx/nginx.http.conf nginx/nginx.conf

# 重启nginx容器
docker-compose -f docker-compose.prod.yml restart nginx
```

## 验证部署

### 1. 检查服务状态

```bash
# 查看所有容器状态
docker-compose -f docker-compose.prod.yml ps

# 应该看到以下容器运行中:
# - kg_nginx_prod
# - kg_api_prod
# - kg_neo4j_prod
# - kg_redis_prod
```

### 2. 测试访问

```bash
# 测试主页
curl http://47.108.152.16/

# 测试健康检查
curl http://47.108.152.16/health

# 测试API
curl http://47.108.152.16/api/health
```

### 3. 查看日志

```bash
# Nginx日志
docker-compose -f docker-compose.prod.yml logs nginx

# API日志
docker-compose -f docker-compose.prod.yml logs api

# 实时查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

## 常见问题排查

### 问题1: 页面仍然空白

**检查点:**
- dist目录是否存在且有内容
- nginx容器是否正常运行
- nginx配置是否正确加载

**解决方法:**
```bash
# 检查dist目录
ls -la dist/

# 进入nginx容器检查
docker exec -it kg_nginx_prod ls -la /usr/share/nginx/html/

# 检查nginx配置
docker exec -it kg_nginx_prod nginx -t
```

### 问题2: API无法访问

**检查点:**
- API容器是否运行
- Neo4j和Redis是否正常
- 网络连接是否正常

**解决方法:**
```bash
# 检查API容器日志
docker-compose -f docker-compose.prod.yml logs api

# 检查API健康状态
docker exec -it kg_api_prod curl http://localhost:8000/health

# 检查容器网络
docker network inspect kg_kg_network
```

### 问题3: 端口无法访问

**检查点:**
- 阿里云安全组是否开放80端口
- 防火墙是否允许访问
- Docker端口映射是否正确

**解决方法:**
```bash
# 检查端口监听
netstat -tlnp | grep :80

# 检查防火墙
firewall-cmd --list-all

# 如需开放端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --reload
```

## 后续优化建议

1. **配置HTTPS**: 使用Let's Encrypt获取免费SSL证书
2. **配置域名**: 将IP地址替换为域名访问
3. **数据备份**: 定期备份Neo4j数据和上传文件
4. **监控告警**: 配置Prometheus和Grafana监控
5. **日志管理**: 配置日志轮转和集中管理

## 联系支持

如果遇到问题，请提供以下信息：
- 错误信息或截图
- 相关日志输出
- 执行的命令和结果

---

**最后更新**: 2025-10-03


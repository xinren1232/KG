# 图谱可视化修复指南

## 问题分析

当前服务器版本的图谱显示问题：
1. ❌ **节点显示为灰色圆圈** - 应该显示彩色节点
2. ❌ **没有节点标签** - 应该显示节点名称
3. ❌ **图例不完整** - 应该显示完整的分类图例
4. ❌ **节点大小单一** - 应该根据连接数变化
5. ❌ **布局过于分散** - 应该更紧凑

## 根本原因

服务器上的 `GraphVisualization.vue` 文件版本过旧，缺少完整的ECharts配置。

## 解决方案

### 方案1：直接替换文件（推荐）

1. **备份当前文件**
```bash
cd /root/KG/apps/web/src/views
cp GraphVisualization.vue GraphVisualization.vue.backup
```

2. **上传新文件**
   - 从本地上传 `apps/web/src/views/GraphVisualization.vue` 到服务器
   - 路径：`/root/KG/apps/web/src/views/GraphVisualization.vue`

3. **重新构建**
```bash
cd /root/KG/apps/web
npm run build
```

4. **重启服务**
```bash
systemctl restart kg-frontend
systemctl status kg-frontend
```

### 方案2：手动修改关键配置

如果无法上传文件，可以手动修改以下关键部分：

#### 1. 确保颜色配置完整（第209-221行）

```javascript
// 分类颜色映射 - 高对比度配色方案
const categoryColors = {
  'Symptom': '#E74C3C',      // 深红色 - 症状/问题
  'Component': '#3498DB',    // 蓝色 - 组件
  'Tool': '#2ECC71',         // 绿色 - 工具
  'Process': '#F39C12',      // 橙色 - 流程
  'TestCase': '#9B59B6',     // 紫色 - 测试用例
  'Metric': '#1ABC9C',       // 青绿色 - 指标
  'Role': '#E67E22',         // 深橙色 - 角色
  'Material': '#34495E',     // 深灰蓝 - 材料
  'Product': '#E91E63',      // 粉红色 - 产品
  'Anomaly': '#C0392B'       // 暗红色 - 异常
}
```

#### 2. 节点配置（第385-424行）

```javascript
data: nodes.map(node => ({
  id: node.id,
  name: node.name,
  category: categories.findIndex(c => c.name === node.category),
  description: node.description || node.properties?.description,
  symbolSize: calculateNodeSize(node.id),
  itemStyle: {
    color: getCategoryColor(node.category),  // 🔴 关键：使用分类颜色
    borderColor: '#fff',
    borderWidth: 3,
    shadowBlur: 15,
    shadowColor: 'rgba(0, 0, 0, 0.4)'
  },
  label: {
    show: true,  // 🔴 关键：显示标签
    fontSize: 10,
    fontWeight: 'normal',
    color: '#333',
    formatter: function(params) {
      // 只显示较大节点的标签，避免文字重叠
      if (params.data.symbolSize > 15) {
        return params.data.name.length > 6
          ? params.data.name.substring(0, 6) + '...'
          : params.data.name
      }
      return ''
    }
  },
  emphasis: {
    label: {
      show: true,
      fontSize: 14,
      fontWeight: 'bold'
    },
    itemStyle: {
      shadowBlur: 25,
      shadowColor: 'rgba(0, 0, 0, 0.6)'
    }
  }
}))
```

#### 3. 图例配置（第322-330行）

```javascript
legend: [{
  data: categories.map(c => c.name),  // 🔴 关键：显示所有分类
  orient: 'vertical',
  left: 10,
  top: 80,
  textStyle: {
    fontSize: 12
  }
}]
```

#### 4. 力导向布局配置（第445-451行）

```javascript
force: {
  repulsion: 300,        // 适中的斥力，适合大量节点
  gravity: 0.1,          // 适中的重力，保持图谱集中
  edgeLength: [30, 100], // 较短的边长，适合密集显示
  layoutAnimation: true,
  friction: 0.6          // 较高摩擦力，稳定布局
}
```

## 验证步骤

1. **访问图谱页面**
   ```
   http://47.97.161.175:5173
   ```

2. **检查以下特性**
   - ✅ 节点显示不同颜色（红、蓝、绿、橙、紫等）
   - ✅ 较大节点显示名称标签
   - ✅ 右侧显示完整图例（Symptom、Component、Tool等）
   - ✅ 节点大小根据连接数变化
   - ✅ 鼠标悬停显示详细信息
   - ✅ 点击节点高亮相邻节点

## 对比截图

### 当前服务器版本（有问题）
- 灰色圆圈
- 无标签
- 无图例
- 布局分散

### 本地正确版本
- 彩色节点（红、蓝、紫、灰等）
- 显示节点名称
- 完整图例
- 紧凑布局

## 技术细节

### 关键函数

1. **getCategoryColor(category)** - 返回分类对应的颜色
2. **calculateNodeSize(nodeId)** - 根据连接数计算节点大小
3. **getNodeConnections(nodeId)** - 获取节点的连接数

### ECharts配置要点

1. **categories** - 必须包含所有分类及其颜色
2. **itemStyle.color** - 必须使用 `getCategoryColor()` 函数
3. **label.show** - 必须设置为 `true`
4. **legend.data** - 必须包含所有分类名称

## 常见问题

### Q1: 为什么节点是灰色的？
A: `itemStyle.color` 没有正确设置，应该使用 `getCategoryColor(node.category)`

### Q2: 为什么看不到标签？
A: `label.show` 设置为 `false` 或未设置

### Q3: 为什么图例不显示？
A: `legend.data` 为空或 `categories` 配置不正确

### Q4: 如何调整节点大小？
A: 修改 `calculateNodeSize()` 函数中的参数

## 快速修复命令

```bash
# 1. 连接服务器
ssh root@47.97.161.175

# 2. 备份当前文件
cd /root/KG/apps/web/src/views
cp GraphVisualization.vue GraphVisualization.vue.backup

# 3. 编辑文件（使用vim或nano）
vim GraphVisualization.vue

# 4. 重新构建
cd /root/KG/apps/web
npm run build

# 5. 重启服务
systemctl restart kg-frontend

# 6. 检查日志
journalctl -u kg-frontend -f
```

## 联系方式

如有问题，请检查：
1. 浏览器控制台是否有错误
2. 前端服务日志：`journalctl -u kg-frontend -n 100`
3. API服务是否正常：`curl http://localhost:8000/api/kg/graph/stats`

## 附录：完整文件位置

- **本地文件**: `d:\KG\apps\web\src\views\GraphVisualization.vue`
- **服务器文件**: `/root/KG/apps/web/src/views/GraphVisualization.vue`
- **构建输出**: `/root/KG/apps/web/dist/`
- **Nginx配置**: `/etc/nginx/sites-available/kg-frontend`


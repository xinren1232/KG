#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
补充因果关系节点的描述、标签等信息
"""

from neo4j import GraphDatabase
import sys

# Neo4j连接配置
NEO4J_URI = "bolt://localhost:7687"
NEO4J_USER = "neo4j"
NEO4J_PASSWORD = "password123"

# 因果关系节点的描述映射（基于之前导入的证据）
CAUSAL_NODE_DESCRIPTIONS = {
    # 原因节点
    "背胶压合治具颗粒杂质": "背胶压合治具上存在颗粒杂质，导致压合时局部受压力不均匀",
    "转印生产现场粉尘污染": "转印生产现场存在粉尘污染、毛丝、颗粒杂质绒线",
    "隧道炉积尘": "隧道炉生产时间周期过长导致积尘，丝印后过隧道炉时灰尘点落在产品上",
    "电镀机台未清洁到位": "电镀机台清洁不彻底，镀产品时尘点打在产品表面",
    "蚀刻过程中两片产品叠加": "蚀刻过程中两片产品叠加一起，酸洗药水未及时流出",
    "温度冲击微跌试验": "温度冲击+微跌测试（正反3200次+4面200次）",
    "镜头镜片脱落": "摄像头模组镜头镜片脱落",
    "EOS/ESD损伤": "电气过应力(EOS)或静电放电(ESD)导致的芯片损伤",
    "转印机台滚筒螺丝松动": "转印机台滚筒螺丝松动，造成滚压压力与速度不稳定",
    "转印胶水厚度不均": "转印胶水厚度偏厚或偏薄，不均匀",
    "天线保压压头磨损": "天线保压压头磨损严重，技术员粘贴绒布导致压头大于产品宽度",
    "泡棉压合机台异常": "泡棉压合岗位机台异常，压合不到位",
    "整机组装过程过压或大电流": "整机组装过程中受到过压或大电流",
    "门限适配问题": "听筒门限适配参数设置不当",
    "TPU原料特性长时间放置": "TPU原料特性导致成品保护套放置时间过长产生变色",
    "框胶受损液晶气泡": "切割导致断面裂纹，框胶受损，液晶进入空气形成气泡",
    "磨粉浓度过高": "磨粉浓度越高对产品表面的摩擦就越大",
    "定位柱高度设计过长": "夹具定位柱高度设计过长、定位柱倒角偏小",
    "CNC振刀碰到产品": "CNC加工时振刀碰到产品",
    "叠片点数方式": "出货组点数时采用叠片点数方式",
    "点胶长度离圆弧位置较远": "点胶长度离圆弧位置较远，保压后出现不均匀",
    "膜片电镀操作员手法不当": "膜片电镀装锅和电镀锅装入电镀仓时操作员手法不当",
    "镀膜机清洁不彻底": "镀膜机清洁不彻底，镀膜过程中微尘依附在产品表面",
    "软对硬贴付设备粘着板粘性降低": "设备粘着板使用过程中粘性降低，撕膜后OCA被轻微带起形变",
    "员工产品拿取手法不当": "员工在生产过程中产品拿取时手法不当（丢放、重叠等）",
    "自动化设备三伤防护不到位": "自动化设备三伤防护未做到位，部分边边角角未防护到位",
    "灯罩背面背胶未激活": "前壳组装灯罩时灯罩背面背胶未激活",
    "70W混用33W/45W外壳": "70W充电器混用33W/45W外壳，材料特性不同",
    "生产线转线未清理干净": "生产线转线时上一机型面壳未清理干净",
    "天气变冷静电": "天气变冷导致静电增加",
    "电容内裂短路": "指纹模组电容内裂导致短路",
    "背光小FPC干涉剐蹭": "背光小FPC存在干涉剐蹭缺口",
    "油墨烘烤温度不足": "隧道炉烘烤温度不足，受天气变冷影响",
    "中框精雕侧键孔宽度偏小": "中框精雕侧键孔宽度中间偏小（超标准下限0.03mm）",
    "开机员换刀后未送测尺寸": "开机员换刀后只填写记录未送测尺寸",
    "FPC绑定表面脏污": "FPC绑定表面存在脏污",
    "制程返修品未二次保压": "制程不良人工返修后未进行二次保压",
    "多个Panel同时翻转": "在Tray盘中集中作业，贴完后集中一起翻转Panel",
    "绿色周转盘老化": "绿色周转盘经过脱泡、过UV，使用时间长慢慢老化",
    "LCD CF层受外力撞击": "LCD CF层受外力撞击破裂框胶开裂",
    "LGP网点受外力挤压": "导光板(LGP)网点受外力挤压或磨擦产生局部受损",
    "Fanout区域金属膜破": "Fanout区域存在金属膜破，FIB切片结果为GE层膜破",
    "胶水涂布后开放时间过长": "胶水涂布后开放时间超过正常时间（1Min±20s）",
    "逆向UV未完全干透": "生产未按工艺流程卡执行，逆向UV还未完全干透",
    "压铸模后模模腔积碳": "压铸模后模模腔成型孔内积碳",
    "PE片自动化贴合设备针头残胶": "PE片自动化贴合设备针头上残留胶水",
    "注塑模具磨损间隙大": "互配模具此孔位模磨损间隙大跑披锋",
    "打包房物料点数纰漏": "打包房物料全检错漏混后，点数时出现纰漏",
    "面漆厚度低于标准值": "产品表面局部位置面漆厚度低于标准值（标准：22±3um）",
    
    # 结果节点
    "电池盖裂纹": "电池盖表面出现裂纹",
    "电池盖颗粒白点异色": "电池盖表面出现颗粒、白点或异色",
    "玻璃镜片白点": "玻璃镜片表面出现白点",
    "玻璃镜片压痕": "玻璃镜片表面出现压痕",
    "摄像头模组对焦模糊": "摄像头模组拍照对焦模糊",
    "芯片开路不良": "芯片出现开路不良",
    "固化后色差": "固化后产品出现色差",
    "中框裂纹压伤": "中框出现裂纹或压伤",
    "泡棉压合不到位": "泡棉压合不到位",
    "喇叭杂音不良": "喇叭播放时出现杂音",
    "听筒THD失真": "听筒总谐波失真(THD)超标",
    "保护套发黄": "保护套材料变色发黄",
    "屏幕黑影不良": "屏幕显示出现黑影",
    "屏幕表面凹印": "屏幕表面出现凹印",
    "孔位变形": "产品孔位拉变形",
    "边缘掉漆": "产品边缘掉漆",
    "玻璃镜片短装": "玻璃镜片数量短装",
    "保护套铁片起翘": "保护套铁片出现起翘",
    "玻璃电池盖脏污异色": "玻璃电池盖出现脏污或异色",
    "镀膜异色点": "镀膜表面出现异色点",
    "贴合气泡": "贴合后出现气泡",
    "CG表面划伤": "CG(盖板玻璃)表面划伤",
    "中框划伤磨花": "中框表面划伤或磨花",
    "面壳灯罩起翘": "面壳灯罩出现起翘",
    "充电器LED灯亮度差异": "充电器LED灯亮度存在差异",
    "外壳混用": "不同型号外壳混用",
    "落尘吸附产生颗粒": "落尘吸附在素材表面产生颗粒",
    "指纹模组测试fail": "指纹模组测试失败",
    "屏幕漏光灯影": "屏幕出现漏光或灯影",
    "达因值偏低": "产品表面达因值偏低",
    "按键卡键不良": "按键出现卡键不良",
    "电池盖尺寸超下限": "电池盖尺寸超出下限",
    "HAST实验后屏显横线条": "HAST实验后屏幕显示出现横线条",
    "屏幕漏光": "屏幕出现漏光现象",
    "屏幕端子区域破损": "屏幕端子区域出现破损",
    "贴合白点异物": "贴合后出现白点或异物",
    "屏幕黑团": "屏幕显示出现黑团",
    "屏幕白斑": "屏幕显示出现白斑",
    "屏幕竖线": "屏幕显示出现竖线",
    "书本盒开胶": "书本盒出现开胶",
    "封套烫金粘花": "封套烫金部分出现粘花",
    "面壳断柱钢片破损": "面壳断柱钢片破损",
    "中框气密性测试NG": "中框气密性测试不合格",
    "中框孔位塑胶高出": "中框孔位塑胶高出",
    "卡托短装": "卡托数量短装",
    "中框铅笔硬度NG": "中框铅笔硬度测试不合格",
}

# 标签映射（根据节点类型）
TAG_MAPPING = {
    # 原因类标签
    "设备问题": ["治具", "机台", "设备", "模具", "压头"],
    "工艺问题": ["工艺", "操作", "手法", "流程", "参数"],
    "材料问题": ["材料", "原料", "胶水", "油墨"],
    "环境问题": ["环境", "天气", "温度", "静电"],
    "清洁问题": ["清洁", "积尘", "污染", "脏污"],
    
    # 结果类标签
    "外观缺陷": ["裂纹", "划伤", "磨花", "白点", "异色", "色差", "掉漆", "起翘", "粘花"],
    "功能失效": ["失真", "杂音", "模糊", "短路", "开路", "测试fail", "NG"],
    "尺寸问题": ["变形", "超下限", "高出"],
    "显示问题": ["屏幕", "漏光", "黑影", "黑团", "白斑", "竖线", "横线条", "凹印"],
    "装配问题": ["短装", "混用", "压合不到位", "开胶", "破损"],
}


def get_tags_for_term(term_name):
    """根据术语名称推断标签"""
    tags = set()
    
    for tag, keywords in TAG_MAPPING.items():
        for keyword in keywords:
            if keyword in term_name:
                tags.add(tag)
    
    # 如果没有匹配到标签，根据是否在结果节点中判断
    if not tags:
        if term_name in ["电池盖裂纹", "电池盖颗粒白点异色", "玻璃镜片白点", "玻璃镜片压痕",
                        "摄像头模组对焦模糊", "芯片开路不良", "固化后色差", "中框裂纹压伤",
                        "泡棉压合不到位", "喇叭杂音不良", "听筒THD失真", "保护套发黄",
                        "屏幕黑影不良", "屏幕表面凹印", "孔位变形", "边缘掉漆",
                        "玻璃镜片短装", "保护套铁片起翘", "玻璃电池盖脏污异色", "镀膜异色点",
                        "贴合气泡", "CG表面划伤", "中框划伤磨花", "面壳灯罩起翘",
                        "充电器LED灯亮度差异", "外壳混用", "落尘吸附产生颗粒", "指纹模组测试fail",
                        "屏幕漏光灯影", "达因值偏低", "按键卡键不良", "电池盖尺寸超下限",
                        "HAST实验后屏显横线条", "屏幕漏光", "屏幕端子区域破损", "贴合白点异物",
                        "屏幕黑团", "屏幕白斑", "屏幕竖线", "书本盒开胶",
                        "封套烫金粘花", "面壳断柱钢片破损", "中框气密性测试NG", "中框孔位塑胶高出",
                        "卡托短装", "中框铅笔硬度NG"]:
            tags.add("质量问题")
        else:
            tags.add("根本原因")
    
    return list(tags)


class CausalNodeEnricher:
    """因果关系节点数据补充器"""
    
    def __init__(self, uri, user, password):
        self.driver = GraphDatabase.driver(uri, auth=(user, password))
        
    def close(self):
        self.driver.close()
        
    def enrich_node(self, tx, name, description, tags):
        """补充节点的描述和标签"""
        # 更新描述
        tx.run("""
            MATCH (t:Term {name: $name})
            SET t.description = $description,
                t.updated_at = datetime()
            RETURN t
        """, name=name, description=description)
        
        # 添加标签
        for tag in tags:
            # 创建或获取Tag节点
            tx.run("""
                MERGE (g:Tag {name: $tag})
                ON CREATE SET g.created_at = datetime()
            """, tag=tag)
            
            # 创建HAS_TAG关系
            tx.run("""
                MATCH (t:Term {name: $name})
                MATCH (g:Tag {name: $tag})
                MERGE (t)-[r:HAS_TAG]->(g)
                ON CREATE SET r.created_at = datetime()
            """, name=name, tag=tag)
    
    def enrich_all_causal_nodes(self):
        """补充所有因果关系节点的数据"""
        stats = {
            "total": 0,
            "enriched": 0,
            "failed": 0,
            "errors": []
        }
        
        with self.driver.session() as session:
            for name, description in CAUSAL_NODE_DESCRIPTIONS.items():
                stats["total"] += 1
                try:
                    tags = get_tags_for_term(name)
                    session.execute_write(
                        self.enrich_node,
                        name,
                        description,
                        tags
                    )
                    stats["enriched"] += 1
                    print(f"✅ 已补充: {name}")
                    print(f"   描述: {description[:50]}...")
                    print(f"   标签: {', '.join(tags)}")
                    
                except Exception as e:
                    stats["failed"] += 1
                    error_msg = f"❌ 失败: {name}: {str(e)}"
                    stats["errors"].append(error_msg)
                    print(error_msg)
        
        return stats


def main():
    """主函数"""
    print("=" * 80)
    print("开始补充因果关系节点数据")
    print("=" * 80)
    
    enricher = CausalNodeEnricher(NEO4J_URI, NEO4J_USER, NEO4J_PASSWORD)
    
    try:
        stats = enricher.enrich_all_causal_nodes()
        
        print("\n" + "=" * 80)
        print("补充完成统计")
        print("=" * 80)
        print(f"总数: {stats['total']}")
        print(f"成功: {stats['enriched']}")
        print(f"失败: {stats['failed']}")
        
        if stats['errors']:
            print("\n错误详情:")
            for error in stats['errors']:
                print(f"  {error}")
        
        print("=" * 80)
        
        return 0 if stats['failed'] == 0 else 1
        
    except Exception as e:
        print(f"\n❌ 补充过程发生错误: {str(e)}")
        return 1
        
    finally:
        enricher.close()


if __name__ == "__main__":
    sys.exit(main())


# 阿里云服务器问题诊断和修复指南

## 当前问题

访问 http://47.108.152.16/ 时：
- ✅ 前端页面可以加载（显示"质量知识图谱助手"）
- ❌ API调用返回 **502 Bad Gateway** 错误
- ❌ `/api/kg/real-stats` 端点无法访问

**502错误说明**：Nginx正常运行，但无法连接到后端API服务。

---

## 立即修复步骤

### 方法1：使用SSH直接修复（推荐）

打开命令行工具（CMD或PowerShell），执行以下命令：

```bash
# 1. 登录服务器
ssh root@47.108.152.16

# 2. 进入项目目录
cd /opt/kg

# 3. 查看容器状态
docker-compose -f docker-compose.prod.yml ps

# 4. 查看API日志（找出错误原因）
docker-compose -f docker-compose.prod.yml logs api --tail=100

# 5. 重启API服务
docker-compose -f docker-compose.prod.yml restart api

# 6. 等待5秒后检查状态
sleep 5
docker-compose -f docker-compose.prod.yml ps

# 7. 测试API是否恢复
curl http://localhost/api/kg/real-stats
```

### 方法2：一键修复命令

复制以下命令，在本地命令行执行：

```bash
ssh root@47.108.152.16 "cd /opt/kg && docker-compose -f docker-compose.prod.yml restart redis && docker-compose -f docker-compose.prod.yml restart api && sleep 5 && docker-compose -f docker-compose.prod.yml ps"
```

---

## 详细诊断步骤

### 步骤1：检查容器状态

```bash
ssh root@47.108.152.16
cd /opt/kg
docker-compose -f docker-compose.prod.yml ps
```

**期望输出**：所有容器状态应该是 `Up`

```
NAME                STATUS
kg_nginx_prod       Up
kg_api_prod         Up
kg_neo4j_prod       Up
kg_redis_prod       Up
```

**如果API容器状态异常**：
- `Restarting` - 服务不断重启，说明启动失败
- `Exit` - 服务已退出，需要查看日志

### 步骤2：查看API日志

```bash
docker-compose -f docker-compose.prod.yml logs api --tail=100
```

**常见错误及解决方案**：

#### 错误1：Redis连接失败
```
redis.exceptions.ConnectionError: Error connecting to Redis
```

**解决方案**：
```bash
# 重启Redis
docker-compose -f docker-compose.prod.yml restart redis
sleep 3
docker-compose -f docker-compose.prod.yml restart api
```

#### 错误2：Neo4j连接失败
```
neo4j.exceptions.ServiceUnavailable: Unable to connect to Neo4j
```

**解决方案**：
```bash
# 重启Neo4j
docker-compose -f docker-compose.prod.yml restart neo4j
sleep 10
docker-compose -f docker-compose.prod.yml restart api
```

#### 错误3：模块导入错误
```
ModuleNotFoundError: No module named 'xxx'
```

**解决方案**：
```bash
# 重新构建API容器
docker-compose -f docker-compose.prod.yml build api
docker-compose -f docker-compose.prod.yml up -d api
```

#### 错误4：配置文件缺失
```
FileNotFoundError: [Errno 2] No such file or directory: 'config/frontend_real_data.json'
```

**解决方案**：
```bash
# 检查配置文件
docker exec kg_api_prod ls -la /app/config/

# 如果文件缺失，需要重新部署配置文件
```

### 步骤3：检查网络连接

```bash
# 检查API容器内部是否能访问Redis
docker exec kg_api_prod ping redis -c 3

# 检查API容器内部是否能访问Neo4j
docker exec kg_api_prod ping neo4j -c 3

# 检查API服务是否在监听8000端口
docker exec kg_api_prod netstat -tlnp | grep 8000
```

### 步骤4：测试API健康检查

```bash
# 从容器内部测试
docker exec kg_api_prod curl http://localhost:8000/health

# 从宿主机测试
curl http://localhost:8000/health

# 通过Nginx测试
curl http://localhost/api/health
```

---

## 完全重启方案

如果上述方法都不行，执行完全重启：

```bash
ssh root@47.108.152.16

cd /opt/kg

# 1. 停止所有容器
docker-compose -f docker-compose.prod.yml down

# 2. 清理旧的容器和网络（可选）
docker system prune -f

# 3. 重新启动所有服务
docker-compose -f docker-compose.prod.yml up -d

# 4. 查看启动日志
docker-compose -f docker-compose.prod.yml logs -f

# 按 Ctrl+C 退出日志查看

# 5. 检查所有容器状态
docker-compose -f docker-compose.prod.yml ps
```

---

## 验证修复结果

### 1. 检查容器状态
```bash
docker-compose -f docker-compose.prod.yml ps
```
所有容器应该显示 `Up`

### 2. 测试API端点
```bash
# 测试健康检查
curl http://localhost/health

# 测试API根路径
curl http://localhost/api/

# 测试real-stats端点
curl http://localhost/api/kg/real-stats
```

### 3. 在浏览器中测试
访问以下URL：
- http://47.108.152.16/ （前端页面）
- http://47.108.152.16/health （健康检查）
- http://47.108.152.16/api/kg/real-stats （API数据）

---

## 常见问题FAQ

### Q1: 为什么会出现502错误？

**A**: 502 Bad Gateway表示Nginx无法连接到后端API服务。可能原因：
1. API容器未启动或启动失败
2. API服务内部错误（Redis/Neo4j连接失败）
3. Docker网络问题
4. API服务端口未正确监听

### Q2: 如何查看实时日志？

**A**: 
```bash
# 查看所有服务日志
docker-compose -f docker-compose.prod.yml logs -f

# 只查看API日志
docker-compose -f docker-compose.prod.yml logs -f api

# 只查看Nginx日志
docker-compose -f docker-compose.prod.yml logs -f nginx
```

### Q3: 如何进入容器内部调试？

**A**:
```bash
# 进入API容器
docker exec -it kg_api_prod bash

# 进入后可以执行：
ls -la /app/
cat /app/config/frontend_real_data.json
python -c "import redis; print('Redis OK')"
curl http://localhost:8000/health
```

### Q4: 如何检查端口占用？

**A**:
```bash
# 在服务器上检查端口
netstat -tlnp | grep -E '80|8000|7687|6379'

# 应该看到：
# :80    - Nginx
# :8000  - API (在容器内)
# :7687  - Neo4j
# :6379  - Redis
```

### Q5: 配置文件在哪里？

**A**: 
- 主配置：`/opt/kg/docker-compose.prod.yml`
- Nginx配置：`/opt/kg/nginx/nginx.conf`
- API配置：`/opt/kg/config/`
- 前端文件：`/opt/kg/dist/`

---

## 预防措施

### 1. 设置自动重启
确保docker-compose.prod.yml中所有服务都有：
```yaml
restart: unless-stopped
```

### 2. 配置健康检查
确保API服务有健康检查配置：
```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
```

### 3. 定期备份
```bash
# 备份Neo4j数据
docker exec kg_neo4j_prod neo4j-admin dump --to=/backups/neo4j-backup.dump

# 备份配置文件
tar -czf /opt/kg-backup-$(date +%Y%m%d).tar.gz /opt/kg/config /opt/kg/nginx
```

### 4. 监控日志
```bash
# 设置日志轮转，防止日志文件过大
# 在docker-compose.prod.yml中添加：
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

---

## 联系支持

如果问题仍未解决，请提供以下信息：

1. **容器状态**：
   ```bash
   docker-compose -f docker-compose.prod.yml ps
   ```

2. **API日志**：
   ```bash
   docker-compose -f docker-compose.prod.yml logs api --tail=200
   ```

3. **Nginx日志**：
   ```bash
   docker-compose -f docker-compose.prod.yml logs nginx --tail=50
   ```

4. **系统信息**：
   ```bash
   docker version
   docker-compose version
   df -h
   free -h
   ```

---

**最后更新**: 2025-10-03


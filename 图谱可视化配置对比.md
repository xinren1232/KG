# 图谱可视化配置对比

## 视觉差异对比

### 当前服务器版本（有问题）
```
特征：
❌ 节点：灰色圆圈，无颜色区分
❌ 标签：完全不显示节点名称
❌ 图例：右侧图例不完整或缺失
❌ 大小：所有节点大小相同
❌ 布局：节点过于分散
❌ 交互：悬停提示信息不完整
```

### 本地正确版本
```
特征：
✅ 节点：彩色显示（红、蓝、绿、橙、紫等）
✅ 标签：较大节点显示名称
✅ 图例：完整显示所有分类（Symptom、Component、Tool等）
✅ 大小：根据连接数动态调整（8-50px）
✅ 布局：紧凑且有层次
✅ 交互：完整的悬停提示和点击高亮
```

## 关键代码差异

### 1. 颜色配置

#### ❌ 错误配置（服务器当前版本）
```javascript
// 可能缺少或不完整
const categoryColors = {
  'Symptom': '#999',  // 灰色
  'Component': '#999'  // 灰色
}
```

#### ✅ 正确配置（本地版本）
```javascript
const categoryColors = {
  'Symptom': '#E74C3C',      // 深红色 - 症状/问题
  'Component': '#3498DB',    // 蓝色 - 组件
  'Tool': '#2ECC71',         // 绿色 - 工具
  'Process': '#F39C12',      // 橙色 - 流程
  'TestCase': '#9B59B6',     // 紫色 - 测试用例
  'Metric': '#1ABC9C',       // 青绿色 - 指标
  'Role': '#E67E22',         // 深橙色 - 角色
  'Material': '#34495E',     // 深灰蓝 - 材料
  'Product': '#E91E63',      // 粉红色 - 产品
  'Anomaly': '#C0392B'       // 暗红色 - 异常
}
```

### 2. 节点样式配置

#### ❌ 错误配置
```javascript
data: nodes.map(node => ({
  id: node.id,
  name: node.name,
  symbolSize: 20,  // 固定大小
  itemStyle: {
    color: '#999'  // 固定灰色
  },
  label: {
    show: false  // 不显示标签
  }
}))
```

#### ✅ 正确配置
```javascript
data: nodes.map(node => ({
  id: node.id,
  name: node.name,
  category: categories.findIndex(c => c.name === node.category),
  description: node.description || node.properties?.description,
  symbolSize: calculateNodeSize(node.id),  // 动态大小
  itemStyle: {
    color: getCategoryColor(node.category),  // 分类颜色
    borderColor: '#fff',
    borderWidth: 3,
    shadowBlur: 15,
    shadowColor: 'rgba(0, 0, 0, 0.4)'
  },
  label: {
    show: true,  // 显示标签
    fontSize: 10,
    fontWeight: 'normal',
    color: '#333',
    formatter: function(params) {
      if (params.data.symbolSize > 15) {
        return params.data.name.length > 6
          ? params.data.name.substring(0, 6) + '...'
          : params.data.name
      }
      return ''
    }
  },
  emphasis: {
    label: {
      show: true,
      fontSize: 14,
      fontWeight: 'bold'
    },
    itemStyle: {
      shadowBlur: 25,
      shadowColor: 'rgba(0, 0, 0, 0.6)'
    }
  }
}))
```

### 3. 图例配置

#### ❌ 错误配置
```javascript
legend: {
  show: false  // 不显示图例
}
// 或者
legend: [{
  data: []  // 空数据
}]
```

#### ✅ 正确配置
```javascript
legend: [{
  data: categories.map(c => c.name),  // 所有分类
  orient: 'vertical',
  left: 10,
  top: 80,
  textStyle: {
    fontSize: 12
  }
}]
```

### 4. 分类数据准备

#### ❌ 错误配置
```javascript
const categories = []  // 空数组
```

#### ✅ 正确配置
```javascript
const categories = [...new Set(nodes.map(n => n.category))].map(cat => ({
  name: cat,
  itemStyle: {
    color: getCategoryColor(cat)
  }
}))
```

### 5. 力导向布局

#### ❌ 错误配置
```javascript
force: {
  repulsion: 1000,  // 斥力过大
  gravity: 0.01,    // 重力过小
  edgeLength: 200   // 边长过长
}
```

#### ✅ 正确配置
```javascript
force: {
  repulsion: 300,        // 适中的斥力
  gravity: 0.1,          // 适中的重力
  edgeLength: [30, 100], // 较短的边长
  layoutAnimation: true,
  friction: 0.6          // 较高摩擦力
}
```

## 必需的辅助函数

### getCategoryColor
```javascript
const getCategoryColor = (category) => {
  return categoryColors[category] || '#606266'
}
```

### calculateNodeSize
```javascript
const calculateNodeSize = (nodeId) => {
  const connections = getNodeConnections(nodeId)
  return Math.min(Math.max(8 + connections * 1.5, 8), 50)
}
```

### getNodeConnections
```javascript
const getNodeConnections = (nodeId) => {
  const relations = graphData.relations || graphData.sampleRelations || []
  return relations.filter(r => r.source === nodeId || r.target === nodeId).length
}
```

## 完整的ECharts Option结构

```javascript
const option = {
  title: {
    text: '硬件质量知识图谱',
    subtext: `${nodes.length}个词条，${relations.length}条关系`,
    left: 'center'
  },
  legend: [{
    data: categories.map(c => c.name),
    orient: 'vertical',
    left: 10,
    top: 80
  }],
  tooltip: {
    trigger: 'item',
    formatter: function(params) {
      // 详细的提示信息
    }
  },
  series: [{
    type: 'graph',
    layout: 'force',
    categories: categories,
    data: nodes.map(node => ({
      // 节点配置
    })),
    links: relations.map(rel => ({
      // 边配置
    })),
    roam: true,
    draggable: true,
    force: {
      // 力导向配置
    },
    emphasis: {
      focus: 'adjacency'
    }
  }]
}
```

## 修复步骤总结

1. **检查颜色配置** - 确保 `categoryColors` 包含所有分类
2. **检查分类数据** - 确保 `categories` 数组正确生成
3. **检查节点配置** - 确保使用 `getCategoryColor()` 和 `calculateNodeSize()`
4. **检查标签配置** - 确保 `label.show = true`
5. **检查图例配置** - 确保 `legend.data` 包含所有分类
6. **检查辅助函数** - 确保三个辅助函数都存在

## 测试清单

部署后检查：
- [ ] 节点显示不同颜色
- [ ] 较大节点显示名称
- [ ] 右侧显示完整图例
- [ ] 节点大小有差异
- [ ] 鼠标悬停显示详细信息
- [ ] 点击节点高亮相邻节点
- [ ] 可以拖拽和缩放
- [ ] 布局紧凑合理

## 调试技巧

### 浏览器控制台检查
```javascript
// 检查分类数据
console.log(categories)

// 检查节点数据
console.log(nodes.map(n => ({
  name: n.name,
  category: n.category,
  color: getCategoryColor(n.category)
})))

// 检查颜色函数
console.log(getCategoryColor('Symptom'))  // 应该返回 '#E74C3C'
```

### 服务器日志检查
```bash
# 前端构建日志
cd /root/KG/apps/web
npm run build 2>&1 | tee build.log

# 服务日志
journalctl -u kg-frontend -n 100 --no-pager
```

## 性能优化建议

1. **节点数量** - 超过1000个节点时考虑采样显示
2. **标签显示** - 只显示重要节点的标签（symbolSize > 15）
3. **动画** - 大量节点时可以关闭 `layoutAnimation`
4. **边的透明度** - 使用 `opacity: 0.7` 减少视觉混乱

## 相关文件

- **主文件**: `apps/web/src/views/GraphVisualization.vue`
- **API接口**: `services/api/routers/kg_router.py`
- **数据源**: Neo4j数据库

## 预期效果

修复后，图谱应该像本地版本一样：
- 🎨 **丰富的颜色** - 10种不同颜色区分分类
- 🏷️ **清晰的标签** - 重要节点显示名称
- 📊 **完整的图例** - 右侧显示所有分类
- 📏 **动态的大小** - 节点大小反映重要性
- 🎯 **良好的布局** - 紧凑且有层次感


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-area {
            border: 2px dashed #409eff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background-color: #fafafa;
        }
        .upload-area:hover {
            border-color: #66b1ff;
            background-color: #f0f9ff;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background-color: #66b1ff;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .file-list {
            margin: 20px 0;
        }
        .file-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å‰ç«¯æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h1>
    <p>æ¨¡æ‹ŸVueç»„ä»¶çš„æ–‡ä»¶ä¸Šä¼ è¡Œä¸º</p>
    <p>APIç«¯ç‚¹: <code>http://127.0.0.1:8000/kg/upload</code></p>

    <div class="upload-area" id="uploadArea">
        <h3>ğŸ“¤ æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</h3>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.pdf,.docx,.doc,.csv,.txt" style="display: none;" multiple>
        <p>æ”¯æŒ Excel(.xlsx/.xls)ã€PDFã€Word(.docx/.doc)ã€CSVã€TXT æ ¼å¼ï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡10MB</p>
        <button onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
        <button onclick="testWithDummyFile()">æµ‹è¯•è™šæ‹Ÿæ–‡ä»¶</button>
    </div>

    <div class="file-list" id="fileList"></div>
    <div id="result"></div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        const uploadedFiles = [];

        function showResult(type, message, data = null) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            let content = `<h4>${type === 'success' ? 'âœ… æˆåŠŸ' : type === 'error' ? 'âŒ å¤±è´¥' : 'â„¹ï¸ ä¿¡æ¯'}</h4>`;
            content += `<p>${message}</p>`;
            if (data) {
                content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            resultDiv.innerHTML = content;
        }

        function updateFileList() {
            const fileListDiv = document.getElementById('fileList');
            if (uploadedFiles.length === 0) {
                fileListDiv.innerHTML = '';
                return;
            }

            let html = '<h3>ğŸ“‹ å·²ä¸Šä¼ æ–‡ä»¶</h3>';
            uploadedFiles.forEach((file, index) => {
                html += `
                    <div class="file-item">
                        <strong>${file.filename}</strong> (${file.file_type})
                        <br>å¤§å°: ${formatFileSize(file.size)}
                        <br>çŠ¶æ€: ${file.status}
                        <br>æ–‡ä»¶ID: ${file.file_id}
                        <br><button onclick="extractKnowledge(${index})">çŸ¥è¯†æŠ½å–</button>
                    </div>
                `;
            });
            fileListDiv.innerHTML = html;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function beforeUpload(file) {
            console.log('Before upload file:', file);
            console.log('File name:', file.name);
            console.log('File size:', file.size);
            console.log('File type:', file.type);

            const isValidType = /\.(xlsx?|pdf|docx?|csv|txt)$/i.test(file.name);
            const isValidSize = file.size / 1024 / 1024 < 10;

            console.log('Is valid type:', isValidType);
            console.log('Is valid size:', isValidSize);

            if (!isValidType) {
                showResult('error', 'æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ');
                return false;
            }
            if (!isValidSize) {
                showResult('error', 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return false;
            }

            console.log('File validation passed');
            return true;
        }

        async function uploadFile(file) {
            if (!beforeUpload(file)) {
                return;
            }

            showResult('info', `æ­£åœ¨ä¸Šä¼ æ–‡ä»¶: ${file.name}`);

            try {
                const formData = new FormData();
                formData.append('file', file);

                console.log('å‘é€ä¸Šä¼ è¯·æ±‚...');

                const response = await fetch(`${API_BASE}/kg/upload`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Upload response status:', response.status);

                const data = await response.json();
                console.log('Upload response data:', data);

                if (response.ok && data.success) {
                    uploadedFiles.push({
                        file_id: data.file_id,
                        filename: data.filename,
                        file_type: data.file_type,
                        size: data.size,
                        upload_time: new Date().toISOString(),
                        status: 'å·²ä¸Šä¼ ',
                        extracting: false,
                        extracted_data: null
                    });
                    
                    updateFileList();
                    showResult('success', 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', data);
                } else {
                    showResult('error', `ä¸Šä¼ å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, data);
                }

            } catch (error) {
                console.error('Upload error:', error);
                showResult('error', `æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.message}`, { error: error.message });
            }
        }

        async function extractKnowledge(fileIndex) {
            const file = uploadedFiles[fileIndex];
            if (!file) return;

            file.extracting = true;
            updateFileList();

            try {
                const response = await fetch(`${API_BASE}/kg/extract`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        file_id: file.file_id,
                        extraction_type: 'auto'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    file.status = 'å·²æŠ½å–';
                    file.extracted_data = result;
                    updateFileList();
                    showResult('success', 'çŸ¥è¯†æŠ½å–å®Œæˆ', result);
                } else {
                    showResult('error', 'çŸ¥è¯†æŠ½å–å¤±è´¥', result);
                }
            } catch (error) {
                showResult('error', 'çŸ¥è¯†æŠ½å–å¤±è´¥', { error: error.message });
            } finally {
                file.extracting = false;
                updateFileList();
            }
        }

        async function testWithDummyFile() {
            console.log('æµ‹è¯•è™šæ‹Ÿæ–‡ä»¶ä¸Šä¼ ');

            const content = 'Hello World Test Content\nè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶\nç”¨äºæµ‹è¯•æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½';
            const blob = new Blob([content], { type: 'text/plain' });
            const file = new File([blob], 'test.txt', { type: 'text/plain' });

            await uploadFile(file);
        }

        // è®¾ç½®æ–‡ä»¶è¾“å…¥äº‹ä»¶
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => uploadFile(file));
        });

        // è®¾ç½®æ‹–æ‹½äº‹ä»¶
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.style.borderColor = '#66b1ff';
            uploadArea.style.backgroundColor = '#f0f9ff';
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.style.borderColor = '#409eff';
            uploadArea.style.backgroundColor = '#fafafa';
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.style.borderColor = '#409eff';
            uploadArea.style.backgroundColor = '#fafafa';
            
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => uploadFile(file));
        });

        // æµ‹è¯•APIè¿æ¥
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                console.log('APIè¿æ¥æµ‹è¯•:', data);
                showResult('info', `APIè¿æ¥æ­£å¸¸ - æœåŠ¡çŠ¶æ€: ${data.status}`);
            } catch (error) {
                console.error('APIè¿æ¥å¤±è´¥:', error);
                showResult('error', `APIè¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æµ‹è¯•è¿æ¥
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>

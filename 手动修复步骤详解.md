# 图谱可视化手动修复步骤详解

## 方法1：文件上传（最简单，推荐）

### 步骤1：准备本地文件
```bash
# 本地文件位置
d:\KG\apps\web\src\views\GraphVisualization.vue
```

### 步骤2：使用SCP上传
```bash
# 在本地PowerShell执行
scp "d:\KG\apps\web\src\views\GraphVisualization.vue" root@47.97.161.175:/root/KG/apps/web/src/views/GraphVisualization.vue
```

### 步骤3：SSH连接服务器
```bash
ssh root@47.97.161.175
```

### 步骤4：重新构建
```bash
cd /root/KG/apps/web
npm run build
```

### 步骤5：重启服务
```bash
systemctl restart kg-frontend
systemctl status kg-frontend
```

---

## 方法2：使用WinSCP（Windows用户）

### 步骤1：下载WinSCP
- 访问: https://winscp.net/
- 下载并安装

### 步骤2：连接服务器
```
主机名: 47.97.161.175
端口: 22
用户名: root
密码: Aa112211
```

### 步骤3：上传文件
```
本地路径: d:\KG\apps\web\src\views\GraphVisualization.vue
远程路径: /root/KG/apps/web/src/views/GraphVisualization.vue
```

### 步骤4：执行构建（使用PuTTY或WinSCP内置终端）
```bash
cd /root/KG/apps/web
npm run build
systemctl restart kg-frontend
```

---

## 方法3：手动编辑（如果无法上传文件）

### 步骤1：SSH连接服务器
```bash
ssh root@47.97.161.175
```

### 步骤2：备份当前文件
```bash
cd /root/KG/apps/web/src/views
cp GraphVisualization.vue GraphVisualization.vue.backup
```

### 步骤3：编辑文件
```bash
vim GraphVisualization.vue
# 或者
nano GraphVisualization.vue
```

### 步骤4：修改关键配置

#### 修改1：颜色配置（约第209行）
找到 `categoryColors` 定义，确保包含以下内容：

```javascript
const categoryColors = {
  'Symptom': '#E74C3C',
  'Component': '#3498DB',
  'Tool': '#2ECC71',
  'Process': '#F39C12',
  'TestCase': '#9B59B6',
  'Metric': '#1ABC9C',
  'Role': '#E67E22',
  'Material': '#34495E',
  'Product': '#E91E63',
  'Anomaly': '#C0392B'
}
```

#### 修改2：节点配置（约第385行）
找到 `data: nodes.map(node => ({`，确保包含：

```javascript
data: nodes.map(node => ({
  id: node.id,
  name: node.name,
  category: categories.findIndex(c => c.name === node.category),
  description: node.description || node.properties?.description,
  symbolSize: calculateNodeSize(node.id),
  itemStyle: {
    color: getCategoryColor(node.category),  // 关键！
    borderColor: '#fff',
    borderWidth: 3,
    shadowBlur: 15,
    shadowColor: 'rgba(0, 0, 0, 0.4)'
  },
  label: {
    show: true,  // 关键！
    fontSize: 10,
    fontWeight: 'normal',
    color: '#333',
    formatter: function(params) {
      if (params.data.symbolSize > 15) {
        return params.data.name.length > 6
          ? params.data.name.substring(0, 6) + '...'
          : params.data.name
      }
      return ''
    }
  }
}))
```

#### 修改3：图例配置（约第322行）
找到 `legend:`，确保：

```javascript
legend: [{
  data: categories.map(c => c.name),
  orient: 'vertical',
  left: 10,
  top: 80,
  textStyle: {
    fontSize: 12
  }
}]
```

#### 修改4：分类数据（约第301行）
找到 `categories` 定义，确保：

```javascript
const categories = [...new Set(nodes.map(n => n.category))].map(cat => ({
  name: cat,
  itemStyle: {
    color: getCategoryColor(cat)
  }
}))
```

### 步骤5：保存并退出
```bash
# vim: 按 ESC，然后输入 :wq
# nano: 按 Ctrl+X，然后 Y，然后 Enter
```

### 步骤6：验证语法
```bash
cd /root/KG/apps/web
npm run build
```

如果有语法错误，会显示错误信息。

---

## 方法4：使用Git（如果服务器有Git仓库）

### 步骤1：在本地提交更改
```bash
cd d:\KG
git add apps/web/src/views/GraphVisualization.vue
git commit -m "修复图谱可视化配置"
git push origin main
```

### 步骤2：在服务器上拉取
```bash
ssh root@47.97.161.175
cd /root/KG
git pull origin main
```

### 步骤3：重新构建
```bash
cd apps/web
npm run build
systemctl restart kg-frontend
```

---

## 验证修复是否成功

### 1. 检查服务状态
```bash
systemctl status kg-frontend
```

应该显示 `active (running)`

### 2. 检查端口
```bash
netstat -tuln | grep 5173
```

应该显示端口5173在监听

### 3. 检查日志
```bash
journalctl -u kg-frontend -n 50 --no-pager
```

不应该有错误信息

### 4. 访问页面
```
http://47.97.161.175:5173
```

### 5. 检查图谱特性
- [ ] 节点显示不同颜色（红、蓝、绿、橙、紫等）
- [ ] 较大节点显示名称标签
- [ ] 右侧显示完整图例（Symptom、Component、Tool等）
- [ ] 节点大小有差异
- [ ] 鼠标悬停显示详细信息
- [ ] 点击节点高亮相邻节点

### 6. 浏览器控制台检查
按F12打开开发者工具，检查：
- Console标签：不应该有错误
- Network标签：API请求应该成功（200状态码）

---

## 常见问题排查

### 问题1：上传文件失败
```bash
# 检查SSH连接
ssh root@47.97.161.175 "echo 'Connection OK'"

# 检查目录权限
ssh root@47.97.161.175 "ls -la /root/KG/apps/web/src/views/"
```

### 问题2：构建失败
```bash
# 检查Node.js版本
node --version  # 应该是 v18+

# 检查npm版本
npm --version

# 清理并重新安装依赖
cd /root/KG/apps/web
rm -rf node_modules package-lock.json
npm install
npm run build
```

### 问题3：服务无法启动
```bash
# 查看详细日志
journalctl -u kg-frontend -n 100 --no-pager

# 检查端口占用
lsof -i :5173

# 手动启动测试
cd /root/KG/apps/web
npm run preview
```

### 问题4：页面显示空白
```bash
# 检查构建输出
ls -la /root/KG/apps/web/dist/

# 检查Nginx配置
cat /etc/nginx/sites-available/kg-frontend

# 重启Nginx
systemctl restart nginx
```

---

## 回滚步骤

如果修复后出现问题，可以回滚：

```bash
# 恢复备份文件
cd /root/KG/apps/web/src/views
cp GraphVisualization.vue.backup GraphVisualization.vue

# 重新构建
cd /root/KG/apps/web
npm run build

# 重启服务
systemctl restart kg-frontend
```

---

## 完整修复脚本

将以下内容保存为 `fix_graph.sh` 并在服务器上执行：

```bash
#!/bin/bash
cd /root/KG/apps/web/src/views
cp GraphVisualization.vue GraphVisualization.vue.backup.$(date +%Y%m%d_%H%M%S)
# 这里上传新文件
cd /root/KG/apps/web
npm run build
systemctl restart kg-frontend
systemctl status kg-frontend
echo "修复完成！访问 http://47.97.161.175:5173 查看效果"
```

执行：
```bash
chmod +x fix_graph.sh
./fix_graph.sh
```

---

## 联系支持

如果以上方法都无法解决问题，请提供：
1. 服务器日志：`journalctl -u kg-frontend -n 100`
2. 浏览器控制台错误截图
3. 当前文件的关键配置截图

---

## 预期效果对比

### 修复前
- 灰色圆圈
- 无标签
- 无图例
- 布局分散

### 修复后
- 彩色节点（10种颜色）
- 清晰标签
- 完整图例
- 紧凑布局

修复成功后，图谱应该像本地版本一样美观和功能完整！


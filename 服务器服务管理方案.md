# ğŸ”§ æœåŠ¡å™¨æœåŠ¡ç®¡ç†å®Œæ•´æ–¹æ¡ˆ

## ğŸ“Š å½“å‰æœåŠ¡çŠ¶æ€æ€»è§ˆ

### âœ… å·²éƒ¨ç½²å¹¶è¿è¡Œçš„æœåŠ¡

| æœåŠ¡åç§° | çŠ¶æ€ | ç«¯å£ | è¿›ç¨‹ç®¡ç† | å¼€æœºè‡ªå¯ |
|---------|------|------|----------|----------|
| **Neo4jæ•°æ®åº“** | âœ… è¿è¡Œä¸­ | 7474, 7687 | systemd | âœ… å·²å¯ç”¨ |
| **Redisç¼“å­˜** | âœ… è¿è¡Œä¸­ | 6379 | systemd | âœ… å·²å¯ç”¨ |
| **APIæœåŠ¡** | âœ… è¿è¡Œä¸­ | 8000 | systemd | âœ… å·²å¯ç”¨ |
| **å‰ç«¯Vite** | âœ… è¿è¡Œä¸­ | 5173 | nohup | âŒ æœªé…ç½® |
| **Nginxç½‘å…³** | âœ… è¿è¡Œä¸­ | 80 | systemd | âœ… å·²å¯ç”¨ |

### ğŸ” æœåŠ¡è¯¦æƒ…

#### 1. Neo4jæ•°æ®åº“
- **è¿›ç¨‹**: Java (PID: 54776)
- **ç«¯å£**: 7474 (HTTP), 7687 (Bolt)
- **ç®¡ç†**: `systemctl {start|stop|restart|status} neo4j`
- **æ—¥å¿—**: `/var/log/neo4j/neo4j.log`

#### 2. Redisç¼“å­˜
- **è¿›ç¨‹**: redis-server (PID: 55191)
- **ç«¯å£**: 6379
- **ç®¡ç†**: `systemctl {start|stop|restart|status} redis-server`
- **æ—¥å¿—**: `/var/log/redis/redis-server.log`

#### 3. APIæœåŠ¡
- **è¿›ç¨‹**: python3 main.py (PID: 56595)
- **ç«¯å£**: 8000
- **ç®¡ç†**: `systemctl {start|stop|restart|status} kg-api`
- **æ—¥å¿—**: `/var/log/kg-api.log`, `/var/log/kg-api-error.log`
- **å·¥ä½œç›®å½•**: `/opt/knowledge-graph/api`

#### 4. å‰ç«¯ViteæœåŠ¡
- **è¿›ç¨‹**: node vite (PID: 56753)
- **ç«¯å£**: 5173
- **ç®¡ç†**: âš ï¸ æ‰‹åŠ¨ç®¡ç† (nohup)
- **æ—¥å¿—**: `/var/log/kg-frontend.log`
- **å·¥ä½œç›®å½•**: `/opt/knowledge-graph/apps/web`

#### 5. Nginxç½‘å…³
- **è¿›ç¨‹**: nginx (PID: 33814)
- **ç«¯å£**: 80
- **ç®¡ç†**: `systemctl {start|stop|restart|status} nginx`
- **é…ç½®**: `/etc/nginx/sites-available/knowledge-graph`
- **æ—¥å¿—**: `/var/log/nginx/access.log`, `/var/log/nginx/error.log`

---

## ğŸš€ æ¨èçš„æœåŠ¡ç®¡ç†æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **systemd** | ç³»ç»ŸåŸç”Ÿã€ç¨³å®šã€å¼€æœºè‡ªå¯ | é…ç½®ç¨å¤æ‚ | â­â­â­â­â­ |
| **PM2** | åŠŸèƒ½ä¸°å¯Œã€ç›‘æ§æ–¹ä¾¿ | éœ€è¦é¢å¤–å®‰è£… | â­â­â­â­ |
| **nohup** | ç®€å•å¿«é€Ÿ | æ— è‡ªåŠ¨é‡å¯ã€æ— ç›‘æ§ | â­â­ |

### æ¨èæ–¹æ¡ˆï¼šsystemd + PM2æ··åˆ

- **åç«¯æœåŠ¡ (API)**: ä½¿ç”¨ **systemd** âœ… (å·²é…ç½®)
- **å‰ç«¯æœåŠ¡ (Vite)**: ä½¿ç”¨ **PM2** æˆ– **systemd**
- **æ•°æ®åº“æœåŠ¡**: ä½¿ç”¨ **systemd** âœ… (å·²é…ç½®)

---

## ğŸ“ å‰ç«¯æœåŠ¡é…ç½®æ–¹æ¡ˆ

### æ–¹æ¡ˆA: ä½¿ç”¨systemd (æ¨è)

#### ä¼˜ç‚¹
- ä¸å…¶ä»–æœåŠ¡ç®¡ç†æ–¹å¼ä¸€è‡´
- ç³»ç»ŸåŸç”Ÿæ”¯æŒ
- å¼€æœºè‡ªå¯
- æ—¥å¿—é›†ä¸­ç®¡ç†

#### é…ç½®æ­¥éª¤

1. **åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶**

```bash
sudo nano /etc/systemd/system/kg-frontend.service
```

å†…å®¹ï¼š
```ini
[Unit]
Description=Knowledge Graph Frontend Service
After=network.target kg-api.service
Wants=kg-api.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/knowledge-graph/apps/web
Environment="PATH=/usr/local/bin:/usr/bin:/bin"
Environment="NODE_ENV=production"
ExecStart=/usr/bin/npm run dev
Restart=always
RestartSec=10
StandardOutput=append:/var/log/kg-frontend.log
StandardError=append:/var/log/kg-frontend-error.log

[Install]
WantedBy=multi-user.target
```

2. **å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡**

```bash
systemctl daemon-reload
systemctl enable kg-frontend
systemctl start kg-frontend
systemctl status kg-frontend
```

---

### æ–¹æ¡ˆB: ä½¿ç”¨PM2

#### ä¼˜ç‚¹
- ä¸°å¯Œçš„ç›‘æ§åŠŸèƒ½
- è‡ªåŠ¨é‡å¯
- æ—¥å¿—ç®¡ç†
- é›†ç¾¤æ¨¡å¼æ”¯æŒ

#### é…ç½®æ­¥éª¤

1. **å®‰è£…PM2**

```bash
npm install -g pm2
```

2. **åˆ›å»ºPM2é…ç½®æ–‡ä»¶**

```bash
nano /opt/knowledge-graph/ecosystem.config.js
```

å†…å®¹ï¼š
```javascript
module.exports = {
  apps: [
    {
      name: 'kg-frontend',
      cwd: '/opt/knowledge-graph/apps/web',
      script: 'npm',
      args: 'run dev',
      env: {
        NODE_ENV: 'production',
        PORT: 5173
      },
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '500M',
      error_file: '/var/log/kg-frontend-error.log',
      out_file: '/var/log/kg-frontend.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z'
    }
  ]
};
```

3. **å¯åŠ¨PM2æœåŠ¡**

```bash
cd /opt/knowledge-graph
pm2 start ecosystem.config.js
pm2 save
pm2 startup systemd
```

4. **PM2å¸¸ç”¨å‘½ä»¤**

```bash
pm2 list                    # æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 status                  # æŸ¥çœ‹çŠ¶æ€
pm2 restart kg-frontend     # é‡å¯å‰ç«¯
pm2 stop kg-frontend        # åœæ­¢å‰ç«¯
pm2 logs kg-frontend        # æŸ¥çœ‹æ—¥å¿—
pm2 monit                   # ç›‘æ§é¢æ¿
```

---

## ğŸ”„ å®Œæ•´æœåŠ¡ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€

```bash
# æ–¹æ³•1: ä½¿ç”¨systemctl
systemctl status neo4j redis-server kg-api nginx

# æ–¹æ³•2: ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬
cat > /usr/local/bin/kg-status << 'EOF'
#!/bin/bash
echo "=== çŸ¥è¯†å›¾è°±ç³»ç»ŸæœåŠ¡çŠ¶æ€ ==="
echo ""
echo "ğŸ“Š systemdæœåŠ¡:"
systemctl is-active neo4j redis-server kg-api nginx | paste -d' ' <(echo -e "Neo4j:\nRedis:\nAPI:\nNginx:") -
echo ""
echo "ğŸ”Œ ç«¯å£ç›‘å¬:"
netstat -tlnp | grep -E '80|5173|8000|7474|6379' | awk '{print $4, $7}'
echo ""
echo "ğŸ’¾ è¿›ç¨‹ä¿¡æ¯:"
ps aux | grep -E 'neo4j|redis|python3 main.py|vite|nginx' | grep -v grep | awk '{print $2, $11, $12, $13}'
EOF

chmod +x /usr/local/bin/kg-status
kg-status
```

### é‡å¯æ‰€æœ‰æœåŠ¡

```bash
# åˆ›å»ºé‡å¯è„šæœ¬
cat > /usr/local/bin/kg-restart << 'EOF'
#!/bin/bash
echo "ğŸ”„ é‡å¯æ‰€æœ‰çŸ¥è¯†å›¾è°±æœåŠ¡..."
systemctl restart redis-server
systemctl restart neo4j
sleep 5
systemctl restart kg-api
systemctl restart kg-frontend  # å¦‚æœä½¿ç”¨systemd
# pm2 restart kg-frontend      # å¦‚æœä½¿ç”¨PM2
systemctl restart nginx
echo "âœ… æ‰€æœ‰æœåŠ¡å·²é‡å¯"
kg-status
EOF

chmod +x /usr/local/bin/kg-restart
```

### åœæ­¢æ‰€æœ‰æœåŠ¡

```bash
cat > /usr/local/bin/kg-stop << 'EOF'
#!/bin/bash
echo "â¹ï¸ åœæ­¢æ‰€æœ‰çŸ¥è¯†å›¾è°±æœåŠ¡..."
systemctl stop kg-frontend  # æˆ– pm2 stop kg-frontend
systemctl stop kg-api
systemctl stop neo4j
systemctl stop redis-server
echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"
EOF

chmod +x /usr/local/bin/kg-stop
```

### å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
cat > /usr/local/bin/kg-start << 'EOF'
#!/bin/bash
echo "â–¶ï¸ å¯åŠ¨æ‰€æœ‰çŸ¥è¯†å›¾è°±æœåŠ¡..."
systemctl start redis-server
systemctl start neo4j
sleep 5
systemctl start kg-api
systemctl start kg-frontend  # æˆ– pm2 start kg-frontend
systemctl start nginx
echo "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"
kg-status
EOF

chmod +x /usr/local/bin/kg-start
```

---

## ğŸ“Š æœåŠ¡ç›‘æ§æ–¹æ¡ˆ

### 1. å¥åº·æ£€æŸ¥è„šæœ¬

```bash
cat > /usr/local/bin/kg-health << 'EOF'
#!/bin/bash
echo "ğŸ¥ çŸ¥è¯†å›¾è°±ç³»ç»Ÿå¥åº·æ£€æŸ¥"
echo ""

# æ£€æŸ¥API
echo -n "APIæœåŠ¡: "
curl -s http://localhost:8000/health > /dev/null && echo "âœ… æ­£å¸¸" || echo "âŒ å¼‚å¸¸"

# æ£€æŸ¥å‰ç«¯
echo -n "å‰ç«¯æœåŠ¡: "
curl -s http://localhost:5173/ > /dev/null && echo "âœ… æ­£å¸¸" || echo "âŒ å¼‚å¸¸"

# æ£€æŸ¥Neo4j
echo -n "Neo4j: "
curl -s http://localhost:7474/ > /dev/null && echo "âœ… æ­£å¸¸" || echo "âŒ å¼‚å¸¸"

# æ£€æŸ¥Redis
echo -n "Redis: "
redis-cli ping > /dev/null 2>&1 && echo "âœ… æ­£å¸¸" || echo "âŒ å¼‚å¸¸"

# æ£€æŸ¥Nginx
echo -n "Nginx: "
curl -s http://localhost/ > /dev/null && echo "âœ… æ­£å¸¸" || echo "âŒ å¼‚å¸¸"

echo ""
echo "ğŸ“ˆ APIè¯¦ç»†çŠ¶æ€:"
curl -s http://localhost:8000/health | python3 -m json.tool 2>/dev/null || echo "æ— æ³•è·å–"
EOF

chmod +x /usr/local/bin/kg-health
```

### 2. å®šæ—¶å¥åº·æ£€æŸ¥ (å¯é€‰)

```bash
# æ·»åŠ åˆ°crontab
crontab -e

# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /usr/local/bin/kg-health >> /var/log/kg-health-check.log 2>&1
```

---

## ğŸ”§ é—®é¢˜æ’æŸ¥æŒ‡å—

### APIæœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹æ—¥å¿—
journalctl -u kg-api -n 100 --no-pager
cat /var/log/kg-api-error.log

# æ£€æŸ¥ä¾èµ–
cd /opt/knowledge-graph/api
pip3 list | grep -E 'fastapi|neo4j|redis|prometheus'

# æ‰‹åŠ¨æµ‹è¯•
cd /opt/knowledge-graph/api
python3 main.py
```

### å‰ç«¯æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/kg-frontend.log

# æ£€æŸ¥Nodeç‰ˆæœ¬
node --version
npm --version

# é‡æ–°å®‰è£…ä¾èµ–
cd /opt/knowledge-graph/apps/web
npm install

# æ‰‹åŠ¨æµ‹è¯•
npm run dev
```

### Neo4jè¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æœåŠ¡
systemctl status neo4j

# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/neo4j/neo4j.log

# æµ‹è¯•è¿æ¥
curl http://localhost:7474/
```

---

## ğŸ“‹ æœåŠ¡é…ç½®æ–‡ä»¶ä½ç½®

| æœåŠ¡ | é…ç½®æ–‡ä»¶ | æ—¥å¿—æ–‡ä»¶ |
|------|----------|----------|
| Neo4j | `/etc/neo4j/neo4j.conf` | `/var/log/neo4j/` |
| Redis | `/etc/redis/redis.conf` | `/var/log/redis/` |
| API | `/etc/systemd/system/kg-api.service` | `/var/log/kg-api*.log` |
| å‰ç«¯ | `/etc/systemd/system/kg-frontend.service` | `/var/log/kg-frontend*.log` |
| Nginx | `/etc/nginx/sites-available/knowledge-graph` | `/var/log/nginx/` |
| ç¯å¢ƒå˜é‡ | `/opt/knowledge-graph/.env` | - |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

### ç«‹å³æ‰§è¡Œ

1. âœ… **é…ç½®å‰ç«¯systemdæœåŠ¡** - æ›¿æ¢å½“å‰çš„nohupæ–¹å¼
2. âœ… **åˆ›å»ºæœåŠ¡ç®¡ç†è„šæœ¬** - kg-status, kg-restartç­‰
3. âœ… **è®¾ç½®å¥åº·æ£€æŸ¥** - å®šæ—¶ç›‘æ§æœåŠ¡çŠ¶æ€

### å¯é€‰ä¼˜åŒ–

1. ğŸ“Š **å®‰è£…PM2** - å¦‚æœéœ€è¦æ›´ä¸°å¯Œçš„ç›‘æ§åŠŸèƒ½
2. ğŸ”” **é…ç½®å‘Šè­¦** - æœåŠ¡å¼‚å¸¸æ—¶å‘é€é€šçŸ¥
3. ğŸ“¦ **é…ç½®å¤‡ä»½** - å®šæ—¶å¤‡ä»½Neo4jæ•°æ®å’Œé…ç½®æ–‡ä»¶
4. ğŸ”’ **é…ç½®HTTPS** - ä½¿ç”¨Let's Encryptè¯ä¹¦
5. ğŸ›¡ï¸ **é…ç½®é˜²ç«å¢™** - é™åˆ¶ç«¯å£è®¿é—®

---

## âœ… æ€»ç»“

å½“å‰æœåŠ¡å™¨å·²ç»æˆåŠŸéƒ¨ç½²äº†æ‰€æœ‰æ ¸å¿ƒæœåŠ¡ï¼š

- âœ… Neo4jæ•°æ®åº“ (systemdç®¡ç†)
- âœ… Redisç¼“å­˜ (systemdç®¡ç†)
- âœ… APIæœåŠ¡ (systemdç®¡ç†)
- âš ï¸ å‰ç«¯æœåŠ¡ (nohupç®¡ç†ï¼Œå»ºè®®å‡çº§ä¸ºsystemd)
- âœ… Nginxç½‘å…³ (systemdç®¡ç†)

**å»ºè®®**: å°†å‰ç«¯æœåŠ¡ä¹Ÿé…ç½®ä¸ºsystemdæœåŠ¡ï¼Œå®ç°ç»Ÿä¸€ç®¡ç†å’Œå¼€æœºè‡ªå¯ã€‚

